#!/usr/bin/env sh
set -e
. "lib/init.sh"

set +e
  env_contents=$(ruby lib/environment.rb $COMPONENT $@)
  if [ $? != 0 ]; then
    printf "$env_contents\n"
    exit 1
  fi
set -e

printf "$env_contents\n" | tee kontena/$COMPONENT/env

confirm "hit enter to deploy $COMPONENT to $HOST"

bin/deploy $HOST $COMPONENT

confirm "\n\nhit enter to initialize $COMPONENT at $HOST"

case $HOST in
  "localhost")
    cd kontena/$COMPONENT && bin/initialize localhost
  ;;
  *)
    ssh $HOST sh kontena/docker/bin/initialize
    ssh $HOST "cd kontena/$COMPONENT && sudo bin/initialize"
  ;;
esac
